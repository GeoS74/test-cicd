name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ´
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    # 2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ SSH
    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    # 3. Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° VPS
    - name: ğŸš€ Deploy to VPS
      run: |
        ssh -o StrictHostKeyChecking=no deployer@${{ secrets.VPS_HOST }} "
          cd ~/app &&
          git pull origin main &&
          docker build -t app:0.0.1 . &&
          docker stop myapp-container || true &&
          docker rm myapp-container || true &&
          docker run -d \
            --name myapp-container \
            --restart unless-stopped \
            -p 3000:3000 \
            app:0.0.1
        "
