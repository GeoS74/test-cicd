name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Забрать код
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: main
    
    # 2. Настроить SSH
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    # 3. Деплой на VPS
    - name: Deploy to VPS
      run: |
        ssh -o StrictHostKeyChecking=no deployer@${{ secrets.VPS_HOST }} "
          # Создаём папку, если её нет
          mkdir -p ~/app
          cd ~/app

          # Если это не git-репозиторий — клонируем
          if [ ! -d .git ]; then
            git clone https://github.com/GeoS74/test-cicd.git .
          fi
          git pull origin main &&
          docker build -t app:0.0.1 . &&
          docker stop myapp-container || true &&
          docker rm myapp-container || true &&
          docker run -d \
            --name myapp-container \
            --restart unless-stopped \
            -p 3000:3000 \
            app:0.0.1
        "
